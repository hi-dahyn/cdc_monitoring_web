<!DOCTYPE html>
<html>
<head>
<title>마이페이지</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
html,body,h1,h2,h3,h4,h5 {font-family: "Raleway", sans-serif}
</style>
</head>
<body class="w3-light-grey">

<div class="w3-bar w3-top w3-large" style="z-index:4; background-color: #0D2514; color: white">
  <button class="w3-bar-item w3-button w3-hide-large w3-hover-none w3-hover-text-light-grey" onclick="w3_open();"><i class="fa fa-bars"></i>  Menu</button>
  <span class="w3-bar-item w3-right">문의하기</span>
</div>

<nav class="w3-sidebar w3-collapse w3-animate-left" style= "background-color: #0D2514; color: white; z-index:3; width:300px;" id="mySidebar"><br>
  <div class="w3-container w3-row">
    <div class="w3-col s4">

    </div>
    <div class="w3-col s8 w3-bar" style="background-color: #0D2514; color: white"; >
      <span>안녕하세요, <strong>Mike</strong></span><br>
      <a href="#" class="w3-bar-item w3-button"><i class="fa fa-envelope"></i></a>
      <a href="#" class="w3-bar-item w3-button"><i class="fa fa-user"></i></a>
      <a href="#" class="w3-bar-item w3-button"><i class="fa fa-cog"></i></a>
    </div>
  </div>
  <hr>
  <div class="w3-container" style="background-color: #0D2514; color: white";>
    <h5>Dashboard</h5>
  </div>
  <div class="w3-bar-block" style="background-color: #0D2514; color: white" >
    <!-- <a href="#" class="w3-bar-item w3-button w3-padding-16 w3-hide-large" style="background-color: #0D2514; color: white"; onclick="w3_close()" title="close menu"><i class="fa fa-remove fa-fw"></i>  Close Menu</a>
    <a href="#" class="w3-bar-item w3-button w3-padding-16 w3-hide-large" style="background-color: #0D2514; color: white"; title="close menu"><i class="fa fa-remove fa-fw"></i>  Close Menu</a> -->
    <a href="/userhome/mypage/device" class="w3-bar-item w3-button w3-padding" ><i class="fa fa-users fa-fw"></i> 기기 등록하기 </a>
    <a href="/userhome/mypage/uploads" class="w3-bar-item w3-button w3-padding"><i class="fa fa-eye fa-fw"></i>  사진 업로드 하기 </a>
    <a href="/userhome/mypage/devicelist" class="w3-bar-item w3-button w3-padding"><i class="fa fa-users fa-fw"></i>  나의 기기정보 확인하기 </a>
    <!-- <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-bullseye fa-fw"></i>  Geo</a>
    <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-diamond fa-fw"></i>  Orders</a>
    <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-bell fa-fw"></i>  News</a>
    <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-bank fa-fw"></i>  General</a>
    <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-history fa-fw"></i>  History</a>
    <a href="#" class="w3-bar-item w3-button w3-padding"><i class="fa fa-cog fa-fw"></i>  Settings</a><br><br> -->
  </div>
</nav>


<!-- Overlay effect when opening sidebar on small screens -->
<div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:300px;margin-top:43px;">

  <!-- Header -->
  <header class="w3-container" style="padding-top:22px">
    <h5><b><i class="fa fa-dashboard"> </i>  나의 대시보드 </b></h5>
  </header>

  <div class="w3-row-padding w3-margin-bottom">
    <div class="w3-quarter">
      <div class="w3-container w3-padding-16" style="background-color: #05264e; color: white">
        <div class="w3-left"><i class="fa fa-comment w3-xxxlarge"></i></div>
        <div class="w3-right">
          <div id="failcount" style="font-size: 30px;" ></div>
        </div>
        <div class="w3-clear"></div>
        <h4>결함 이미지</h4>
      </div>
    </div>
    <div class="w3-quarter">
      <div class="w3-container w3-padding-16" style="background-color: #19411c; color: white">
        <div class="w3-left"><i class="fa fa-eye w3-xxxlarge"></i></div>
        <div class="w3-right">
          <div id="successcount" style="font-size: 30px;" ></div>
        </div>
        <div class="w3-clear"></div>
        <h4>정상 이미지</h4>
      </div>
    </div>
    <div class="w3-quarter">
      <div class="w3-container  w3-padding-16" style="background-color: #518630; color: white">
        <div class="w3-left"><i class="fa fa-share-alt w3-xxxlarge"></i></div>
        <div class="w3-right">
          <div id="websocketStatus" style="font-size: 30px;" >on</div>
        </div>
        <div class="w3-clear"></div>
        <h4>기기 연결상태</h4>
      </div>
    </div>
    <div class="w3-quarter">
      <div class="w3-container  w3-text-white w3-padding-16" style="background-color: #A7AFAB; color: white">
        <div class="w3-left"><i class="fa fa-users w3-xxxlarge"></i></div>
        <div class="w3-right">
          <div id="deviceCount" style="font-size: 30px;" ></div>
        </div>
        <div class="w3-clear"></div>
        <h4>등록된 기기</h4>
      </div>
    </div>
  </div>

  <style>
    .w3-fifth {
        width: 20%; 
    }
    .w3-fifth img {
        width: 80%; 
        display: block; 
        margin: auto; 
    }
</style>

<div class="w3-panel">
    <hr><div  style="font-size: 20px;" >최근 결함 이미지</div><hr>
    <div id="imageGallery" class="w3-row-padding" style="margin:10px; display: flex;">
        <% images.forEach(image => { %>
            <div class="w3-fifth">
                <img src="<%= image %>" alt="Image" >
            </div>
        <% }) %>
    </div>
</div>
<hr>

  <hr>
  <div class="w3-container">
    <h5>실시간 현황</h5>
    <p>결함 이미지 비율</p>
    <div class="w3-grey">
      <div id="defectRatio" class="w3-container w3-center w3-padding" style="background-color: #05264e; color: white"></div>
    </div>

    <!-- <p>정상 이미지 비율</p>
    <div class="w3-grey">
      <div class="w3-container w3-center w3-padding " style="width:87.5%; background-color: #19411c; color: white">87.5%</div>
    </div>

    <p>비율</p>
    <div class="w3-grey">
      <div class="w3-container w3-center w3-padding " style="width:75%; background-color: #518630; color: white">75%</div>
    </div> -->
  </div>
  <hr>

  <div class="w3-container">
    <h5>사진 업로드 현황</h5>
    <table class="w3-table w3-striped w3-bordered w3-border w3-hoverable w3-white">
      <tr>
        <td>United States</td>
        <td>65%</td>
      </tr>
      <tr>
        <td>UK</td>
        <td>15.7%</td>
      </tr>
      <tr>
        <td>Russia</td>
        <td>5.6%</td>
      </tr>
      <tr>
        <td>Spain</td>
        <td>2.1%</td>
      </tr>
      <tr>
        <td>India</td>
        <td>1.9%</td>
      </tr>
      <tr>
        <td>France</td>
        <td>1.5%</td>
      </tr>
    </table><br>
    <button class="w3-button w3-dark-grey">More Countries  <i class="fa fa-arrow-right"></i></button>
  </div>
  <hr>
  <div class="w3-container">
    <h5>Recent Users</h5>
    <ul class="w3-ul w3-card-4 w3-white">
      <li class="w3-padding-16">
        <img src="/w3images/avatar2.png" class="w3-left w3-circle w3-margin-right" style="width:35px">
        <span class="w3-xlarge">Mike</span><br>
      </li>
      <li class="w3-padding-16">
        <img src="/w3images/avatar5.png" class="w3-left w3-circle w3-margin-right" style="width:35px">
        <span class="w3-xlarge">Jill</span><br>
      </li>
      <li class="w3-padding-16">
        <img src="/w3images/avatar6.png" class="w3-left w3-circle w3-margin-right" style="width:35px">
        <span class="w3-xlarge">Jane</span><br>
      </li>
    </ul>
  </div>
  <hr>

  <div class="w3-container">
    <h5>Recent Comments</h5>
    <div class="w3-row">
      <div class="w3-col m2 text-center">
        <img class="w3-circle" src="/w3images/avatar3.png" style="width:96px;height:96px">
      </div>
      <div class="w3-col m10 w3-container">
        <h4>John <span class="w3-opacity w3-medium">Sep 29, 2014, 9:12 PM</span></h4>
        <p>Keep up the GREAT work! I am cheering for you!! Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p><br>
      </div>
    </div>

    <div class="w3-row">
      <div class="w3-col m2 text-center">
        <img class="w3-circle" src="/w3images/avatar1.png" style="width:96px;height:96px">
      </div>
      <div class="w3-col m10 w3-container">
        <h4>Bo <span class="w3-opacity w3-medium">Sep 28, 2014, 10:15 PM</span></h4>
        <p>Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p><br>
      </div>
    </div>
  </div>
  <br>
  <div class="w3-container w3-dark-grey w3-padding-32">
    <div class="w3-row">
      <div class="w3-container w3-third">
        <h5 class="w3-bottombar w3-border-green">Demographic</h5>
        <p>Language</p>
        <p>Country</p>
        <p>City</p>
      </div>
      <div class="w3-container w3-third">
        <h5 class="w3-bottombar w3-border-red">System</h5>
        <p>Browser</p>
        <p>OS</p>
        <p>More</p>
      </div>
      <div class="w3-container w3-third">
        <h5 class="w3-bottombar w3-border-orange">Target</h5>
        <p>Users</p>
        <p>Active</p>
        <p>Geo</p>
        <p>Interests</p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="w3-container w3-padding-16 w3-light-grey">
    <h4>FOOTER</h4>
    <p>Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a></p>
  </footer>

  <!-- End page content -->
</div>

<script>
  const evtSource = new EventSource('/userhome/mypage/data');

  evtSource.onmessage = function(event) {
      const data = JSON.parse(event.data);

      if (data.type === 'add') {const imgElement = document.createElement('img');
imgElement.src = data.path;
imgElement.setAttribute('data-filename', extractFilename(data.path)); 
document.getElementById('imageGallery').appendChild(imgElement);

// function extractFilename(path) {
//     return path.split('/').pop(); // 경로에서 파일명만 추출
// }
} else if (data.type === 'unlink') {

    const filename = extractFilename(data.path);
    const images = document.querySelectorAll('#imageGallery img[data-filename]');
    images.forEach(img => {
        if (img.getAttribute('data-filename') === filename) {
            img.remove(); 
        }
    });
}
function extractFilename(path) {
    return path.split('/').pop(); 
}
    
        let totalFailCount = 0;
        let totalSuccessCount = 0;

        data.devices.forEach(device => {
            totalFailCount += device.failcount;
            totalSuccessCount += device.successcount;
        });


   let defectRatio = 0;
    if (totalFailCount !== 0) { 
        defectRatio =  totalFailCount / (totalFailCount + totalSuccessCount) * 100;
    }

 
    const defectRatioElement = document.getElementById('defectRatio');
    defectRatioElement.style.width = `${defectRatio}%`;
    defectRatioElement.innerHTML = `${defectRatio.toFixed(2)}%`;

      const failCountElement = document.getElementById('successcount');
      failCountElement.innerHTML = `${totalFailCount}`;

      const successCountElement = document.getElementById('failcount');
      successCountElement.innerHTML = `${totalSuccessCount}`;

      const deviceCountElement = document.getElementById('deviceCount');
      deviceCountElement.innerHTML = `${data.deviceCount}`;
  };

  evtSource.onerror = function(event) {
      console.error('EventSource failed.');
      evtSource.close();
  };
</script>

<script>
  function fetchAndUpdateImages() {
    fetch('/get-latest-images')
      .then(response => response.json())
      .then(images => {
        const gallery = document.getElementById('imageGallery');
        gallery.innerHTML = ''; 

        images.forEach(image => {
          const imgDiv = document.createElement('div');
          imgDiv.className = 'w3-fifth';
          imgDiv.innerHTML = `<img src="${image}" alt="Image">`;
          gallery.appendChild(imgDiv);
        });
      })
      .catch(err => console.error('Error fetching images:', err));
  }

  setInterval(fetchAndUpdateImages, 2000);
</script>

</body>
</html>